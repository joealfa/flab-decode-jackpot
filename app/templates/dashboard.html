{% extends "base.html" %}

{% block title %}Analysis Dashboard - {{ data.game_type }}{% endblock %}

{% block content %}
<div class="container dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>
                <i class="fas fa-chart-line"></i>
                {{ data.game_type }} Analysis
            </h1>
            <p class="subtitle">
                {{ overall_stats.total_draws }} draws from {{ data.start_date }} to {{ data.end_date }}
            </p>
        </div>
        <div class="header-actions">
            {% if report_filename %}
            <button onclick="exportCurrentAnalysis()" class="btn btn-success" style="margin-right: 10px;">
                <i class="fas fa-download"></i> Export Analysis
            </button>
            {% endif %}
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
        </div>
    </div>

    <!-- Ultimate Predictions (NEW) -->
    {% if ultimate_predictions %}
    <div class="card predictions-card ultimate-section accordion-card">
        <div class="card-header gradient-header-ultimate accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-star"></i> Ultimate Predictions - Comprehensive Analysis</h2>
                <p>Combining ALL analysis methods: frequency, temporal patterns, recent trends, and winning patterns</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content active">
            <div class="randomness-disclaimer">
                <i class="fas fa-info-circle"></i>
                <strong>Important:</strong> {{ ultimate_predictions[0].analysis.randomness_acknowledgment if ultimate_predictions else "While based on historical patterns, lottery draws are random. Past performance does not guarantee future results." }}
            </div>

            <div class="predictions-grid">
                {% for prediction in ultimate_predictions %}
                <div class="prediction-item ultimate-pred rank-{{ loop.index }}">
                    <div class="prediction-rank ultimate-rank">#{{ loop.index }}</div>
                    <div class="prediction-content">
                        <div class="prediction-numbers">
                            {% for num in prediction.numbers %}
                            <span class="number-ball ultimate-ball">{{ num }}</span>
                            {% endfor %}
                        </div>
                        <div class="prediction-stats">
                            <div class="stat">
                                <span class="stat-label">Ultimate Score</span>
                                <span class="stat-value ultimate-score">{{ prediction.ultimate_confidence_score }}%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Pattern</span>
                                <span class="stat-value">{{ prediction.analysis.even_odd }}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Sum</span>
                                <span class="stat-value">{{ prediction.analysis.sum }}</span>
                            </div>
                        </div>
                        <div class="scoring-breakdown">
                            <div class="breakdown-title">Score Breakdown:</div>
                            <div class="breakdown-items">
                                <span class="breakdown-item">Freq: {{ prediction.scoring_components.frequency_score }}%</span>
                                <span class="breakdown-item">Pattern: {{ prediction.scoring_components.pattern_match }}%</span>
                                <span class="breakdown-item">Temporal: {{ prediction.scoring_components.temporal_consistency }}%</span>
                                <span class="breakdown-item">Balance: {{ prediction.scoring_components.balance_score }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Top Predictions -->
    <div class="card predictions-card accordion-card">
        <div class="card-header gradient-header accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-lightbulb"></i> Top 5 Predicted Combinations</h2>
                <p>Based on comprehensive probability analysis</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <div class="predictions-grid">
                {% for prediction in top_predictions %}
                <div class="prediction-item rank-{{ loop.index }}">
                    <div class="prediction-rank">#{{ loop.index }}</div>
                    <div class="prediction-content">
                        <div class="prediction-numbers">
                            {% for num in prediction.numbers %}
                            <span class="number-ball">{{ num }}</span>
                            {% endfor %}
                        </div>
                        <div class="prediction-stats">
                            <div class="stat">
                                <span class="stat-label">Confidence</span>
                                <span class="stat-value">{{ prediction.confidence_score }}%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Pattern</span>
                                <span class="stat-value">{{ prediction.analysis.even_odd }}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Sum</span>
                                <span class="stat-value">{{ prediction.analysis.sum }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Winner-Optimized Predictions -->
    <div class="card predictions-card winner-section accordion-card">
        <div class="card-header gradient-header-winner accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-trophy"></i> Winner-Optimized Predictions</h2>
                <p>Based on analysis of draws that had jackpot winners</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content active">
            <div class="predictions-grid">
                {% for prediction in winning_predictions %}
                <div class="prediction-item winner-pred rank-{{ loop.index }}">
                    <div class="prediction-rank winner-rank">#{{ loop.index }}</div>
                    <div class="prediction-content">
                        <div class="prediction-numbers">
                            {% for num in prediction.numbers %}
                            <span class="number-ball winner-ball">{{ num }}</span>
                            {% endfor %}
                        </div>
                        <div class="prediction-stats">
                            <div class="stat">
                                <span class="stat-label">Win Probability</span>
                                <span class="stat-value winner-score">{{ prediction.win_probability_score }}%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Pattern</span>
                                <span class="stat-value">{{ prediction.analysis.even_odd }}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Type</span>
                                <span class="stat-value winner-badge">{{ prediction.prediction_type }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pattern Analysis Report -->
    {% if pattern_analysis and pattern_analysis.latest_draw %}
    <div class="card pattern-analysis-card accordion-card">
        <div class="card-header gradient-header-pattern accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-chart-line"></i> Consecutive Draw Pattern Analysis</h2>
                <p>Analysis of how numbers transition from one draw to the next</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <div class="pattern-analysis-content">
                <!-- Latest Draw Info -->
                <div class="analysis-section">
                    <h3><i class="fas fa-calendar-check"></i> Most Recent Draw</h3>
                    <div class="latest-draw-box">
                        <div class="draw-date">
                            <i class="fas fa-clock"></i> {{ pattern_analysis.latest_draw.date }}
                        </div>
                        <div class="draw-numbers">
                            {% for num in pattern_analysis.latest_draw.numbers %}
                            <span class="number-ball-large">{{ num }}</span>
                            {% endfor %}
                        </div>
                        <div class="draw-sum">
                            Sum: <strong>{{ pattern_analysis.latest_draw.sum }}</strong>
                        </div>
                    </div>
                </div>

                <!-- Carryover Analysis -->
                <div class="analysis-section">
                    <h3><i class="fas fa-exchange-alt"></i> Number Carryover Patterns</h3>
                    <p class="section-description">How many numbers typically repeat from one draw to the next</p>
                    <div class="pattern-metrics">
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-chart-bar"></i></div>
                            <div class="metric-content">
                                <span class="metric-label">Average Carryover</span>
                                <span class="metric-value">{{ pattern_analysis.average_carryover }}</span>
                                <span class="metric-description">numbers per draw</span>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-trophy"></i></div>
                            <div class="metric-content">
                                <span class="metric-label">Most Common</span>
                                <span class="metric-value">{{ pattern_analysis.most_common_carryover }}</span>
                                <span class="metric-description">numbers repeated</span>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-plus-circle"></i></div>
                            <div class="metric-content">
                                <span class="metric-label">Average New Numbers</span>
                                <span class="metric-value">{{ pattern_analysis.average_new_numbers }}</span>
                                <span class="metric-description">fresh numbers per draw</span>
                            </div>
                        </div>
                    </div>

                    <!-- Carryover Distribution -->
                    <div class="distribution-section">
                        <h4>Carryover Distribution</h4>
                        <div class="distribution-bars">
                            {% for count, frequency in pattern_analysis.carryover_distribution.items()|sort %}
                            <div class="distribution-item">
                                <span class="dist-label">{{ count }} numbers</span>
                                <div class="dist-bar-container">
                                    <div class="dist-bar" style="width: {{ (frequency / pattern_analysis.carryover_distribution.values()|max * 100)|round }}%">
                                        <span class="dist-value">{{ frequency }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Pattern Transitions -->
                <div class="analysis-section">
                    <h3><i class="fas fa-arrows-alt-h"></i> Even/Odd Pattern Transitions</h3>
                    <p class="section-description">How even/odd patterns change between consecutive draws</p>
                    <div class="transition-highlight">
                        <div class="highlight-label">Most Common Transition</div>
                        <div class="highlight-value">{{ pattern_analysis.most_common_pattern_transition }}</div>
                    </div>

                    <div class="transitions-grid">
                        {% for transition, count in (pattern_analysis.pattern_transitions.items()|list|sort(attribute=1, reverse=True))[:10] %}
                        <div class="transition-card">
                            <span class="transition-pattern">{{ transition }}</span>
                            <span class="transition-count">{{ count }} times</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Sum Differences -->
                <div class="analysis-section">
                    <h3><i class="fas fa-calculator"></i> Sum Variation Between Draws</h3>
                    <div class="metric-card highlight-metric">
                        <div class="metric-icon"><i class="fas fa-chart-area"></i></div>
                        <div class="metric-content">
                            <span class="metric-label">Average Sum Difference</span>
                            <span class="metric-value">{{ pattern_analysis.average_sum_difference }}</span>
                            <span class="metric-description">points change between consecutive draws</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pattern-Based Predictions -->
    {% if pattern_predictions %}
    <div class="card predictions-card pattern-section accordion-card">
        <div class="card-header gradient-header-pattern accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-chart-network"></i> Pattern-Based Predictions</h2>
                <p>Based on consecutive draw pattern analysis</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content active">

            <div class="predictions-grid" style="margin-top: 20px;">
                {% for prediction in pattern_predictions %}
                <div class="prediction-item pattern-pred rank-{{ loop.index }}">
                    <div class="prediction-rank pattern-rank">#{{ loop.index }}</div>
                    <div class="prediction-content">
                        <div class="prediction-numbers">
                            {% for num in prediction.numbers %}
                            <span class="number-ball pattern-ball">{{ num }}</span>
                            {% endfor %}
                        </div>
                        <div class="prediction-stats">
                            <div class="stat">
                                <span class="stat-label">Pattern Score</span>
                                <span class="stat-value pattern-score">{{ prediction.pattern_score }}%</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Carryover</span>
                                <span class="stat-value">{{ prediction.carryover_count }} nums</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">New</span>
                                <span class="stat-value">{{ prediction.new_count }} nums</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Type</span>
                                <span class="stat-value pattern-badge">{{ prediction.prediction_type }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Historical Observations (NEW) -->
    {% if historical_observations %}
    <div class="card observations-card accordion-card">
        <div class="card-header gradient-header-observations accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-book-open"></i> Historical Data Observations</h2>
                <p>Key insights from analyzing historical lottery data</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <!-- Highly Frequent Numbers -->
            {% if historical_observations.highly_frequent_numbers %}
            <div class="observation-section">
                <h3><i class="fas fa-chart-line"></i> Highly Frequent Numbers</h3>
                <div class="observation-grid">
                    {% for item in historical_observations.highly_frequent_numbers[:10] %}
                    <div class="observation-item">
                        <span class="obs-number">{{ item.number }}</span>
                        <div class="obs-details">
                            <span class="obs-freq">{{ item.frequency }} times</span>
                            <span class="obs-rate">{{ item.appearance_rate }}%</span>
                            <p class="obs-text">{{ item.observation }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Year-to-Year Insights -->
            {% if historical_observations.year_to_year_insights %}
            <div class="observation-section">
                <h3><i class="fas fa-calendar-alt"></i> Year-to-Year Consistency</h3>
                <p class="section-description">Numbers that perform consistently across multiple years</p>
                <div class="consistency-grid">
                    {% for item in historical_observations.year_to_year_insights[:8] %}
                    <div class="consistency-card">
                        <div class="consist-number">{{ item.number }}</div>
                        <div class="consist-details">
                            <div class="consist-stat">
                                <span class="stat-label">Consistency Score</span>
                                <span class="stat-value">{{ (item.consistency_score * 100)|round(1) }}%</span>
                            </div>
                            <div class="consist-stat">
                                <span class="stat-label">Years Appeared</span>
                                <span class="stat-value">{{ item.years_appeared }}</span>
                            </div>
                            <p class="consist-note">{{ item.observation }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Common Repeating Patterns -->
            {% if historical_observations.common_repeating_patterns %}
            <div class="observation-section">
                <h3><i class="fas fa-sync-alt"></i> Common Repeating Numbers</h3>
                <p class="section-description">Numbers that frequently appear in consecutive draws</p>
                <div class="repeating-grid">
                    {% for item in historical_observations.common_repeating_patterns[:10] %}
                    <div class="repeating-item">
                        <span class="repeat-number">{{ item.number }}</span>
                        <span class="repeat-count">{{ item.consecutive_occurrences }} consecutive</span>
                        <p class="repeat-text">{{ item.observation }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Temporal Insights -->
            {% if historical_observations.temporal_insights %}
            <div class="observation-section">
                <h3><i class="fas fa-clock"></i> Monthly Patterns</h3>
                <div class="monthly-patterns-grid">
                    {% for item in historical_observations.temporal_insights[:6] %}
                    <div class="monthly-pattern-card">
                        <h4>{{ item.month }}</h4>
                        <div class="month-numbers">
                            {% for num in item.hot_numbers %}
                            <span class="number-badge">{{ num }}</span>
                            {% endfor %}
                        </div>
                        <p class="month-obs">{{ item.observation }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Temporal Pattern Analysis (NEW) -->
    {% if temporal_patterns %}
    <div class="card temporal-card accordion-card">
        <div class="card-header gradient-header-temporal accordion-header" onclick="toggleAccordion(this)">
            <div>
                <h2><i class="fas fa-layer-group"></i> Temporal Pattern Analysis</h2>
                <p>Analysis across years, months, weeks, and days</p>
            </div>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <!-- Year-over-Year Trends -->
            {% if temporal_patterns.year_over_year_trends %}
            <div class="temporal-section">
                <h3><i class="fas fa-chart-area"></i> Year-over-Year Analysis</h3>
                <p class="section-description">Analyzed {{ temporal_patterns.year_over_year_trends.total_years }} years: {{ temporal_patterns.year_over_year_trends.years_analyzed|join(', ') }}</p>

                {% if temporal_patterns.year_over_year_trends.consistent_performers %}
                <div class="performers-section">
                    <h4>Most Consistent Performers Across Years</h4>
                    <div class="performers-grid">
                        {% for perf in temporal_patterns.year_over_year_trends.consistent_performers[:12] %}
                        <div class="performer-card">
                            <span class="perf-number">{{ perf.number }}</span>
                            <div class="perf-stats">
                                <span class="perf-label">Avg Frequency</span>
                                <span class="perf-value">{{ perf.average_frequency }}</span>
                            </div>
                            <div class="perf-stats">
                                <span class="perf-label">Consistency</span>
                                <span class="perf-value">{{ (perf.consistency_score * 100)|round(0) }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if temporal_patterns.year_over_year_trends.distinct_high_performers %}
                <div class="distinct-performers-section">
                    <h4>Distinct High Performers (Exceptional years)</h4>
                    <div class="distinct-grid">
                        {% for perf in temporal_patterns.year_over_year_trends.distinct_high_performers[:8] %}
                        <div class="distinct-card">
                            <div class="distinct-header">
                                <span class="distinct-number">{{ perf.number }}</span>
                                <span class="distinct-year">{{ perf.year }}</span>
                            </div>
                            <div class="distinct-info">
                                <span class="improve-badge">+{{ perf.improvement_over_average|round(0) }}% above average</span>
                                <span class="freq-text">{{ perf.frequency }} times</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- By Month Analysis -->
            {% if temporal_patterns.by_month %}
            <div class="temporal-section">
                <h3><i class="fas fa-calendar"></i> Monthly Breakdown</h3>
                <div class="monthly-breakdown">
                    {% for month, data in temporal_patterns.by_month.items() %}
                    <div class="month-breakdown-card">
                        <h4>{{ month }}</h4>
                        <span class="month-draws">{{ data.total_draws }} draws</span>
                        <div class="month-hot-numbers">
                            {% for num in data.hot_numbers %}
                            <span class="hot-num-badge">{{ num }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Winner Analysis Stats -->
    {% if overall_stats.winner_analysis and overall_stats.winner_analysis.total_winning_draws > 0 %}
    <div class="card winner-stats-card accordion-card">
        <div class="card-header accordion-header" onclick="toggleAccordion(this)">
            <h2><i class="fas fa-trophy-alt"></i> Winner Analysis</h2>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <div class="stats-grid">
                <div class="stat-card winner-stat">
                    <div class="stat-icon winner-icon">
                        <i class="fas fa-award"></i>
                    </div>
                    <h3>Total Winning Draws</h3>
                    <p class="big-stat">{{ overall_stats.winner_analysis.total_winning_draws }}</p>
                    <p class="stat-detail">Win Rate: {{ overall_stats.winner_analysis.win_rate }}%</p>
                </div>

                <div class="stat-card winner-stat">
                    <div class="stat-icon winner-icon">
                        <i class="fas fa-fire-alt"></i>
                    </div>
                    <h3>Hot Winning Numbers</h3>
                    <div class="number-list">
                        {% for num in overall_stats.winner_analysis.hot_winning_numbers[:6] %}
                        <span class="number-tag winner">{{ num }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="stat-card winner-stat">
                    <div class="stat-icon winner-icon">
                        <i class="fas fa-calendar-star"></i>
                    </div>
                    <h3>Best Winning Days</h3>
                    <div class="best-days">
                        {% for day, count in overall_stats.winner_analysis.best_winning_days %}
                        <div class="day-item">
                            <span class="day-name">{{ day }}</span>
                            <span class="day-count">{{ count }} wins</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="stat-card winner-stat">
                    <div class="stat-icon winner-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h3>Best Winning Months</h3>
                    <div class="best-months">
                        {% for month, count in overall_stats.winner_analysis.best_winning_months %}
                        <div class="month-item">
                            <span class="month-name">
                                {% if month == 1 %}January
                                {% elif month == 2 %}February
                                {% elif month == 3 %}March
                                {% elif month == 4 %}April
                                {% elif month == 5 %}May
                                {% elif month == 6 %}June
                                {% elif month == 7 %}July
                                {% elif month == 8 %}August
                                {% elif month == 9 %}September
                                {% elif month == 10 %}October
                                {% elif month == 11 %}November
                                {% elif month == 12 %}December
                                {% endif %}
                            </span>
                            <span class="month-count">{{ count }} wins</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Next Win Probability -->
            {% if overall_stats.winner_analysis.next_win_probability and overall_stats.winner_analysis.next_win_probability.average_days_between_wins %}
            <div class="win-probability-section">
                <h3><i class="fas fa-clock"></i> Next Win Probability</h3>
                <div class="probability-grid">
                    <div class="prob-card">
                        <span class="prob-label">Last Win</span>
                        <span class="prob-value">{{ overall_stats.winner_analysis.next_win_probability.last_win_date }}</span>
                    </div>
                    <div class="prob-card">
                        <span class="prob-label">Days Since</span>
                        <span class="prob-value">{{ overall_stats.winner_analysis.next_win_probability.days_since_last_win }} days</span>
                    </div>
                    <div class="prob-card">
                        <span class="prob-label">Average Gap</span>
                        <span class="prob-value">{{ overall_stats.winner_analysis.next_win_probability.average_days_between_wins }} days</span>
                    </div>
                    <div class="prob-card highlight">
                        <span class="prob-label">Probability Status</span>
                        <span class="prob-value status">{{ overall_stats.winner_analysis.next_win_probability.probability_status }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Winning Patterns -->
            <div class="winning-patterns">
                <h3><i class="fas fa-pattern"></i> Winning Patterns</h3>
                <div class="pattern-grid">
                    <div class="pattern-card">
                        <h4>Even/Odd in Wins</h4>
                        <p class="pattern-highlight">{{ overall_stats.winner_analysis.winning_even_odd_patterns.most_common_pattern }}</p>
                        <small>Appeared in {{ overall_stats.winner_analysis.winning_even_odd_patterns.most_common_count }} winning draws</small>
                    </div>
                    <div class="pattern-card">
                        <h4>High/Low in Wins</h4>
                        <p class="pattern-highlight">{{ overall_stats.winner_analysis.winning_high_low_patterns.most_common_pattern }}</p>
                        <small>Appeared in {{ overall_stats.winner_analysis.winning_high_low_patterns.most_common_count }} winning draws</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <i class="fas fa-info-circle"></i>
                <p>No winning draws found in the dataset. Analysis is based on all draws.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Overall Statistics -->
    <div class="card accordion-card">
        <div class="card-header accordion-header" onclick="toggleAccordion(this)">
            <h2><i class="fas fa-chart-bar"></i> Overall Statistics</h2>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <h3>Hot Numbers</h3>
                    <div class="number-list">
                        {% for num in overall_stats.hot_numbers %}
                        <span class="number-tag hot">{{ num }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-snowflake"></i>
                    </div>
                    <h3>Cold Numbers</h3>
                    <div class="number-list">
                        {% for num in overall_stats.cold_numbers %}
                        <span class="number-tag cold">{{ num }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <h3>Even/Odd Pattern</h3>
                    <p class="pattern-text">Most Common: <strong>{{ overall_stats.even_odd_analysis.most_common_pattern }}</strong></p>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-sort-amount-up"></i>
                    </div>
                    <h3>High/Low Pattern</h3>
                    <p class="pattern-text">Most Common: <strong>{{ overall_stats.high_low_analysis.most_common_pattern }}</strong></p>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
                <div class="chart-container">
                    <h3>Number Frequency Distribution</h3>
                    <canvas id="frequencyChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Sum Distribution</h3>
                    <canvas id="sumChart"></canvas>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <h3>Even/Odd Patterns</h3>
                    <canvas id="evenOddChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Day of Week Distribution</h3>
                    <canvas id="dayChart"></canvas>
                </div>
            </div>

            <!-- New Heatmaps (NEW) -->
            {% if chart_data.heatmap %}
            <div class="heatmaps-section">
                <h3><i class="fas fa-th"></i> Heatmap Visualizations</h3>
                <p class="section-description">Frequency patterns across time dimensions</p>

                <div class="heatmap-grid">
                    {% if chart_data.heatmap.by_month %}
                    <div class="heatmap-container">
                        <h4>{{ chart_data.heatmap.by_month.title }}</h4>
                        <canvas id="heatmapMonth"></canvas>
                    </div>
                    {% endif %}

                    {% if chart_data.heatmap.by_year %}
                    <div class="heatmap-container">
                        <h4>{{ chart_data.heatmap.by_year.title }}</h4>
                        <canvas id="heatmapYear"></canvas>
                    </div>
                    {% endif %}

                    {% if chart_data.heatmap.by_day %}
                    <div class="heatmap-container">
                        <h4>{{ chart_data.heatmap.by_day.title }}</h4>
                        <canvas id="heatmapDay"></canvas>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- New Trend Graphs (NEW) -->
            {% if chart_data.trends %}
            <div class="trends-section">
                <h3><i class="fas fa-chart-line"></i> Trend Analysis Over Time</h3>
                <p class="section-description">Track how patterns evolve over time</p>

                <div class="trend-grid">
                    {% if chart_data.trends.top_numbers_over_time %}
                    <div class="trend-container full-width">
                        <h4>{{ chart_data.trends.top_numbers_over_time.title }}</h4>
                        <canvas id="trendTopNumbers"></canvas>
                    </div>
                    {% endif %}

                    {% if chart_data.trends.average_sum_trend %}
                    <div class="trend-container">
                        <h4>{{ chart_data.trends.average_sum_trend.title }}</h4>
                        <canvas id="trendAvgSum"></canvas>
                    </div>
                    {% endif %}

                    {% if chart_data.trends.even_odd_ratio_trend %}
                    <div class="trend-container">
                        <h4>{{ chart_data.trends.even_odd_ratio_trend.title }}</h4>
                        <canvas id="trendEvenOdd"></canvas>
                    </div>
                    {% endif %}

                    {% if chart_data.trends.consistency_trend %}
                    <div class="trend-container full-width">
                        <h4>{{ chart_data.trends.consistency_trend.title }}</h4>
                        <canvas id="trendConsistency"></canvas>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Day-Specific Analysis -->
    <div class="card accordion-card">
        <div class="card-header accordion-header" onclick="toggleAccordion(this)">
            <h2><i class="fas fa-calendar-week"></i> Day-Specific Analysis</h2>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <div class="days-tabs">
                <button class="day-tab active" data-day="Monday">Monday</button>
                <button class="day-tab" data-day="Tuesday">Tuesday</button>
                <button class="day-tab" data-day="Wednesday">Wednesday</button>
                <button class="day-tab" data-day="Thursday">Thursday</button>
                <button class="day-tab" data-day="Friday">Friday</button>
                <button class="day-tab" data-day="Saturday">Saturday</button>
                <button class="day-tab" data-day="Sunday">Sunday</button>
            </div>

            {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
            <div class="day-content" id="day-{{ day }}" {% if day != 'Monday' %}style="display: none;"{% endif %}>
                {% if day_analysis[day].total_draws > 0 %}
                <div class="day-stats">
                    <div class="day-header">
                        <h3>{{ day }}</h3>
                        <span class="badge">{{ day_analysis[day].total_draws }} draws</span>
                    </div>

                    <div class="day-grid">
                        <div class="day-section">
                            <h4><i class="fas fa-fire"></i> Hot Numbers for {{ day }}</h4>
                            <div class="number-list">
                                {% for num in day_analysis[day].hot_numbers %}
                                <span class="number-tag hot">{{ num }}</span>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="day-section">
                            <h4><i class="fas fa-star"></i> Top Predictions for {{ day }}</h4>
                            <div class="day-predictions">
                                {% for pred in day_analysis[day].predicted_combinations %}
                                <div class="day-prediction">
                                    <span class="pred-rank">#{{ loop.index }}</span>
                                    <div class="pred-numbers">
                                        {% for num in pred.numbers %}
                                        <span class="number-ball small">{{ num }}</span>
                                        {% endfor %}
                                    </div>
                                    <span class="pred-confidence">{{ pred.confidence_score }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>No draws found for {{ day }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Detailed Statistics -->
    <div class="card accordion-card">
        <div class="card-header accordion-header" onclick="toggleAccordion(this)">
            <h2><i class="fas fa-list"></i> Detailed Statistics</h2>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="card-body accordion-content">
            <div class="detailed-stats">
                <div class="detail-row">
                    <span class="detail-label">Total Draws:</span>
                    <span class="detail-value">{{ overall_stats.total_draws }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Average Sum:</span>
                    <span class="detail-value">{{ "%.2f"|format(overall_stats.sum_analysis.average_sum) }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Sum Range:</span>
                    <span class="detail-value">{{ overall_stats.sum_analysis.min_sum }} - {{ overall_stats.sum_analysis.max_sum }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Draws with Consecutive Numbers:</span>
                    <span class="detail-value">{{ overall_stats.consecutive_analysis.draws_with_consecutive }} ({{ "%.1f"|format(overall_stats.consecutive_analysis.percentage_with_consecutive) }}%)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Chart data from Flask
if (typeof chartData === 'undefined') {
    var chartData;
}
chartData = {{ chart_data | tojson | safe }};

// Store chart instances
if (typeof chartInstances === 'undefined') {
    var chartInstances = {};
}

// Accordion functionality (must be global for onclick to work)
window.toggleAccordion = function(headerElement) {
    const card = headerElement.closest('.accordion-card');
    const content = card.querySelector('.accordion-content');
    const icon = headerElement.querySelector('.accordion-icon');

    // Toggle the content
    content.classList.toggle('active');

    // Rotate the icon
    icon.classList.toggle('rotated');

    // If opening the accordion, re-initialize charts after animation
    if (content.classList.contains('active')) {
        setTimeout(() => {
            // Re-initialize charts if this is the statistics section
            const hasCharts = content.querySelector('canvas');
            if (typeof initializeCharts === 'function') {
                initializeCharts();
            }

            const rect = card.getBoundingClientRect();
            const isInViewport = rect.top >= 0 && rect.bottom <= window.innerHeight;

            if (!isInViewport) {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }, 400);
    }
};

// Helper function to create heatmap
window.createHeatmap = function(canvasId, heatmapData) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const data = heatmapData.data;
    const xLabels = heatmapData.x_labels;
    const yLabels = heatmapData.y_labels;

    // Find max value for color scaling
    let maxValue = 0;
    data.forEach(row => {
        row.forEach(val => {
            if (val > maxValue) maxValue = val;
        });
    });

    // Flatten data for Chart.js matrix
    const dataPoints = [];
    data.forEach((row, y) => {
        row.forEach((value, x) => {
            dataPoints.push({
                x: x,
                y: y,
                v: value
            });
        });
    });

    return new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                data: dataPoints,
                backgroundColor: function(context) {
                    const value = context.raw.v;
                    const ratio = value / maxValue;
                    // Color gradient from blue (low) to red (high)
                    const r = Math.floor(ratio * 255);
                    const g = Math.floor((1 - ratio) * 100);
                    const b = Math.floor((1 - ratio) * 255);
                    return `rgba(${r}, ${g}, ${b}, 0.8)`;
                },
                pointRadius: function(context) {
                    const canvas = context.chart.canvas;
                    return Math.min(canvas.width / xLabels.length, 15) / 2;
                },
                pointHoverRadius: function(context) {
                    const canvas = context.chart.canvas;
                    return Math.min(canvas.width / xLabels.length, 15) / 1.5;
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const point = context[0].raw;
                            return `Number ${yLabels[point.y]}, ${xLabels[point.x]}`;
                        },
                        label: function(context) {
                            return `Frequency: ${context.raw.v}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    min: -0.5,
                    max: xLabels.length - 0.5,
                    ticks: {
                        callback: function(value) {
                            return xLabels[Math.round(value)] || '';
                        },
                        stepSize: 1
                    },
                    grid: { display: false }
                },
                y: {
                    type: 'linear',
                    min: -0.5,
                    max: yLabels.length - 0.5,
                    ticks: {
                        callback: function(value) {
                            return yLabels[Math.round(value)] || '';
                        },
                        stepSize: yLabels.length <= 10 ? 1 : 5
                    },
                    grid: { display: false }
                }
            }
        }
    });
};

// Helper function for chart colors
window.getColorForIndex = function(idx, alpha = 1) {
    const colors = [
        `rgba(99, 102, 241, ${alpha})`,
        `rgba(245, 158, 11, ${alpha})`,
        `rgba(16, 185, 129, ${alpha})`,
        `rgba(239, 68, 68, ${alpha})`,
        `rgba(139, 92, 246, ${alpha})`,
        `rgba(236, 72, 153, ${alpha})`,
        `rgba(14, 165, 233, ${alpha})`,
        `rgba(132, 204, 22, ${alpha})`,
        `rgba(251, 146, 60, ${alpha})`,
        `rgba(168, 85, 247, ${alpha})`
    ];
    return colors[idx % colors.length];
};

// Function to initialize all charts
window.initializeCharts = function() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        return;
    }

    // Check if chartData exists
    if (!chartData) {
        return;
    }

    // Destroy all existing chart instances first
    if (chartInstances) {
        Object.keys(chartInstances).forEach(key => {
            if (chartInstances[key] && typeof chartInstances[key].destroy === 'function') {
                try {
                    chartInstances[key].destroy();
                } catch (e) {
                    // Silent error handling
                }
            }
        });
        chartInstances = {};
    }

    // Frequency Chart
    const freqCanvas = document.getElementById('frequencyChart');

    if (freqCanvas && chartData.number_frequency) {
        // Check if canvas is visible
        const isVisible = freqCanvas.offsetWidth > 0 && freqCanvas.offsetHeight > 0;

        if (isVisible) {
            try {
            chartInstances.frequencyChart = new Chart(freqCanvas, {
                type: 'bar',
                data: {
                    labels: chartData.number_frequency.labels,
                    datasets: [{
                        label: 'Frequency',
                        data: chartData.number_frequency.values,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            } catch (error) {
                // Silent error handling
            }
        }
    }

    // Sum Distribution Chart
    const sumCanvas = document.getElementById('sumChart');
    if (sumCanvas && chartData.sum_distribution) {
        try {
            chartInstances.sumChart = new Chart(sumCanvas, {
                type: 'line',
                data: {
                    labels: chartData.sum_distribution.labels,
                    datasets: [{
                        label: 'Frequency',
                        data: chartData.sum_distribution.values,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        } catch (error) {
            // Silent error handling
        }
    }

    // Even/Odd Chart
    const evenOddCanvas = document.getElementById('evenOddChart');
    if (evenOddCanvas && chartData.even_odd_patterns) {
        try {
            chartInstances.evenOddChart = new Chart(evenOddCanvas, {
                type: 'pie',
                data: {
                    labels: chartData.even_odd_patterns.labels,
                    datasets: [{
                        data: chartData.even_odd_patterns.values,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        } catch (error) {
            // Silent error handling
        }
    }

    // Day Distribution Chart
    const dayCanvas = document.getElementById('dayChart');
    if (dayCanvas && chartData.day_distribution) {
        try {
            chartInstances.dayChart = new Chart(dayCanvas, {
                type: 'bar',
                data: {
                    labels: chartData.day_distribution.labels,
                    datasets: [{
                        label: 'Number of Draws',
                        data: chartData.day_distribution.values,
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        } catch (error) {
            // Silent error handling
        }
    }

    // Heatmap Charts (NEW)
    if (chartData.heatmap) {
        // Heatmap by Month
        if (chartData.heatmap.by_month && document.getElementById('heatmapMonth')) {
            try {
                chartInstances.heatmapMonth = createHeatmap('heatmapMonth', chartData.heatmap.by_month);
            } catch (error) {
                // Silent error handling
            }
        }

        // Heatmap by Year
        if (chartData.heatmap.by_year && document.getElementById('heatmapYear')) {
            try {
                chartInstances.heatmapYear = createHeatmap('heatmapYear', chartData.heatmap.by_year);
            } catch (error) {
                // Silent error handling
            }
        }

        // Heatmap by Day
        if (chartData.heatmap.by_day && document.getElementById('heatmapDay')) {
            try {
                chartInstances.heatmapDay = createHeatmap('heatmapDay', chartData.heatmap.by_day);
            } catch (error) {
                // Silent error handling
            }
        }
    }

    // Trend Charts (NEW)
    if (chartData.trends) {
        // Top Numbers Over Time
        if (chartData.trends.top_numbers_over_time && document.getElementById('trendTopNumbers')) {
            chartInstances.trendTopNumbers = new Chart(document.getElementById('trendTopNumbers'), {
                type: 'line',
                data: {
                    labels: chartData.trends.top_numbers_over_time.labels,
                    datasets: chartData.trends.top_numbers_over_time.datasets.map((dataset, idx) => ({
                        label: dataset.label,
                        data: dataset.data,
                        borderColor: getColorForIndex(idx),
                        backgroundColor: getColorForIndex(idx, 0.1),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Average Sum Trend
        if (chartData.trends.average_sum_trend && document.getElementById('trendAvgSum')) {
            chartInstances.trendAvgSum = new Chart(document.getElementById('trendAvgSum'), {
                type: 'line',
                data: {
                    labels: chartData.trends.average_sum_trend.labels,
                    datasets: [{
                        label: 'Average Sum',
                        data: chartData.trends.average_sum_trend.data,
                        borderColor: 'rgba(99, 102, 241, 1)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        // Even/Odd Ratio Trend
        if (chartData.trends.even_odd_ratio_trend && document.getElementById('trendEvenOdd')) {
            chartInstances.trendEvenOdd = new Chart(document.getElementById('trendEvenOdd'), {
                type: 'line',
                data: {
                    labels: chartData.trends.even_odd_ratio_trend.labels,
                    datasets: [{
                        label: 'Even Number Ratio',
                        data: chartData.trends.even_odd_ratio_trend.data,
                        borderColor: 'rgba(245, 158, 11, 1)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Consistency Trend
        if (chartData.trends.consistency_trend && document.getElementById('trendConsistency')) {
            chartInstances.trendConsistency = new Chart(document.getElementById('trendConsistency'), {
                type: 'line',
                data: {
                    labels: chartData.trends.consistency_trend.labels,
                    datasets: [{
                        label: 'Consistency Score',
                        data: chartData.trends.consistency_trend.data,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }
    }
};

// Initialize charts when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for the page to fully render, then initialize charts
    setTimeout(function() {
        initializeCharts();
    }, 100);
});

// Day tabs functionality
document.querySelectorAll('.day-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const day = this.dataset.day;

        // Update active tab
        document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        // Show corresponding content
        document.querySelectorAll('.day-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById('day-' + day).style.display = 'block';
    });
});

// Export current analysis
function exportCurrentAnalysis() {
    {% if report_filename %}
    window.location.href = `/api/export-analysis/{{ report_filename }}`;
    {% else %}
    alert('Report filename not available for export.');
    {% endif %}
}

// Display comparison results (kept for historical viewing if needed)
function displayComparisonResults(results) {
    const container = document.getElementById('comparisonResults');

    let html = `
        <div class="comparison-container">
            <h3><i class="fas fa-check-circle"></i> Prediction Accuracy Analysis</h3>
            <div class="actual-result">
                <h4>Actual Draw Result</h4>
                <div class="number-list">
                    ${results.actual_numbers.map(num => `<span class="number-ball">${num}</span>`).join('')}
                </div>
                <p><strong>Date:</strong> ${results.draw_date}</p>
            </div>

            <div class="comparison-section">
                <h4><i class="fas fa-lightbulb"></i> Top Predictions Comparison</h4>
                <div class="comparison-grid">
                    ${results.top_predictions_comparison.map(pred => `
                        <div class="comparison-item ${pred.matches >= 3 ? 'good-match' : ''}">
                            <span class="rank-badge">#${pred.rank}</span>
                            <div class="pred-numbers">
                                ${pred.predicted_numbers.map(num => `
                                    <span class="number-ball ${results.actual_numbers.includes(num) ? 'matched' : ''}">${num}</span>
                                `).join('')}
                            </div>
                            <div class="match-info">
                                <span class="matches-badge">${pred.matches}/6 matches</span>
                                <span class="confidence-text">${pred.confidence_score}% confidence</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="comparison-section">
                <h4><i class="fas fa-trophy"></i> Winning Predictions Comparison</h4>
                <div class="comparison-grid">
                    ${results.winning_predictions_comparison.map(pred => `
                        <div class="comparison-item ${pred.matches >= 3 ? 'good-match' : ''}">
                            <span class="rank-badge winner">#${pred.rank}</span>
                            <div class="pred-numbers">
                                ${pred.predicted_numbers.map(num => `
                                    <span class="number-ball ${results.actual_numbers.includes(num) ? 'matched' : ''}">${num}</span>
                                `).join('')}
                            </div>
                            <div class="match-info">
                                <span class="matches-badge">${pred.matches}/6 matches</span>
                                <span class="confidence-text">${pred.win_probability_score}% win score</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            ${results.pattern_predictions_comparison && results.pattern_predictions_comparison.length > 0 ? `
            <div class="comparison-section">
                <h4><i class="fas fa-chart-network"></i> Pattern Predictions Comparison</h4>
                <div class="comparison-grid">
                    ${results.pattern_predictions_comparison.map(pred => `
                        <div class="comparison-item ${pred.matches >= 3 ? 'good-match' : ''}">
                            <span class="rank-badge" style="background: #f59e0b;">#${pred.rank}</span>
                            <div class="pred-numbers">
                                ${pred.predicted_numbers.map(num => `
                                    <span class="number-ball ${results.actual_numbers.includes(num) ? 'matched' : ''}">${num}</span>
                                `).join('')}
                            </div>
                            <div class="match-info">
                                <span class="matches-badge">${pred.matches}/6 matches</span>
                                <span class="confidence-text">${pred.pattern_score}% pattern score</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;

    container.innerHTML = html;
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}
</script>

<style>
/* Accordion Styles */
.accordion-card {
    transition: all 0.3s ease;
}

.accordion-header {
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s ease;
}

.accordion-header:hover {
    opacity: 0.95;
}

.accordion-icon {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
    color: currentColor;
}

.accordion-icon.rotated {
    transform: rotate(180deg);
}

.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0;
}

.accordion-content.active {
    max-height: 10000px;
    padding: 30px;
}

/* Ensure header children don't interfere with click */
.accordion-header > div {
    pointer-events: none;
}

.accordion-header h2,
.accordion-header p {
    pointer-events: none;
}

.comparison-container {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 12px;
}

.actual-result {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
}

.comparison-section {
    margin-top: 20px;
}

.comparison-grid {
    display: grid;
    gap: 15px;
    margin-top: 15px;
}

.comparison-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 2px solid #e0e0e0;
    transition: all 0.3s;
}

.comparison-item.good-match {
    border-color: #10b981;
    background: #f0fdf4;
}

.rank-badge {
    background: #667eea;
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: bold;
}

.rank-badge.winner {
    background: #f59e0b;
}

.pred-numbers {
    display: flex;
    gap: 5px;
    flex: 1;
}

.number-ball.matched {
    background: #10b981 !important;
    color: white;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

.match-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
    align-items: flex-end;
}

.matches-badge {
    background: #10b981;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: bold;
}

.confidence-text {
    color: #666;
    font-size: 0.85rem;
}

.gradient-header-pattern {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.pattern-section {
    border: 2px solid #f59e0b;
}

.pattern-info {
    background: #fffbeb;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.pattern-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.pattern-stat {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-value-large {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #f59e0b;
    margin: 10px 0;
}

.stat-value-small {
    display: block;
    font-size: 0.9rem;
    color: #666;
    margin-top: 5px;
}

.number-list-small {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin: 10px 0;
    flex-wrap: wrap;
}

.pattern-rank {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.pattern-ball {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.pattern-score {
    color: #f59e0b;
    font-weight: bold;
}

.pattern-badge {
    background: #f59e0b;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
}

/* Pattern Analysis Report Styles */
.pattern-analysis-content {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.analysis-section {
    background: #fffbeb;
    padding: 25px;
    border-radius: 12px;
    border-left: 4px solid #f59e0b;
}

.analysis-section h3 {
    color: #d97706;
    margin-bottom: 10px;
    font-size: 1.3rem;
}

.analysis-section h4 {
    color: #d97706;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.section-description {
    color: #666;
    font-size: 0.95rem;
    margin-bottom: 20px;
}

.latest-draw-box {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.draw-date {
    color: #666;
    font-size: 0.95rem;
    margin-bottom: 15px;
}

.draw-numbers {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
}

.number-ball-large {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
}

.draw-sum {
    color: #666;
    font-size: 1rem;
    margin-top: 15px;
}

.pattern-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.metric-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    display: flex;
    gap: 15px;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.metric-icon {
    font-size: 2rem;
    color: #f59e0b;
}

.metric-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.metric-label {
    font-size: 0.85rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #f59e0b;
}

.metric-description {
    font-size: 0.85rem;
    color: #888;
}

.highlight-metric {
    max-width: 400px;
    border: 2px solid #f59e0b;
}

.distribution-section {
    margin-top: 20px;
}

.distribution-bars {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.distribution-item {
    display: flex;
    align-items: center;
    gap: 15px;
}

.dist-label {
    min-width: 100px;
    font-weight: 600;
    color: #666;
}

.dist-bar-container {
    flex: 1;
    background: #f3f4f6;
    border-radius: 8px;
    overflow: hidden;
    height: 30px;
}

.dist-bar {
    height: 100%;
    background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    transition: width 0.3s ease;
}

.dist-value {
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
}

.transition-highlight {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.highlight-label {
    font-size: 0.9rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
}

.highlight-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #f59e0b;
}

.transitions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.transition-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

.transition-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.transition-pattern {
    font-weight: bold;
    color: #333;
    font-size: 0.95rem;
}

.transition-count {
    color: #f59e0b;
    font-size: 0.85rem;
}

/* Ultimate Predictions Styles (NEW) */
.gradient-header-ultimate {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.ultimate-section {
    border: 3px solid #f59e0b;
}

.randomness-disclaimer {
    background: #fffbeb;
    border-left: 4px solid #f59e0b;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-size: 0.95rem;
}

.ultimate-rank {
    background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%);
}

.ultimate-ball {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
}

.ultimate-score {
    color: #f59e0b;
    font-weight: bold;
    font-size: 1.1rem;
}

.scoring-breakdown {
    margin-top: 15px;
    padding: 10px;
    background: #fffbeb;
    border-radius: 6px;
}

.breakdown-title {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 8px;
    font-weight: 600;
}

.breakdown-items {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.breakdown-item {
    background: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #333;
    border: 1px solid #f59e0b;
}

/* Historical Observations Styles (NEW) */
.gradient-header-observations {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.observation-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f0fdf4;
    border-radius: 12px;
    border-left: 4px solid #10b981;
}

.observation-section h3 {
    color: #059669;
    margin-bottom: 15px;
}

.observation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.observation-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    gap: 15px;
    align-items: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.obs-number {
    font-size: 2rem;
    font-weight: bold;
    color: #10b981;
    min-width: 50px;
    text-align: center;
}

.obs-details {
    flex: 1;
}

.obs-freq {
    display: block;
    font-weight: 600;
    color: #333;
}

.obs-rate {
    display: block;
    font-size: 0.9rem;
    color: #666;
    margin: 5px 0;
}

.obs-text {
    font-size: 0.85rem;
    color: #666;
    margin: 8px 0 0;
}

.consistency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.consistency-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.consist-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #10b981;
    text-align: center;
    margin-bottom: 15px;
}

.consist-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.consist-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.consist-note {
    font-size: 0.85rem;
    color: #666;
    margin-top: 10px;
    font-style: italic;
}

.repeating-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.repeating-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.repeat-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #10b981;
    margin-bottom: 10px;
}

.repeat-count {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.repeat-text {
    font-size: 0.85rem;
    color: #666;
}

.monthly-patterns-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
}

.monthly-pattern-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.monthly-pattern-card h4 {
    color: #10b981;
    margin-bottom: 15px;
}

.month-numbers {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.number-badge {
    background: #10b981;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: bold;
}

.month-obs {
    font-size: 0.85rem;
    color: #666;
}

/* Temporal Patterns Styles (NEW) */
.gradient-header-temporal {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.temporal-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #eef2ff;
    border-radius: 12px;
    border-left: 4px solid #6366f1;
}

.temporal-section h3 {
    color: #4f46e5;
    margin-bottom: 15px;
}

.temporal-section h4 {
    color: #4f46e5;
    margin: 20px 0 15px;
}

.performers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
}

.performer-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.perf-number {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #6366f1;
    margin-bottom: 10px;
}

.perf-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.85rem;
}

.perf-label {
    color: #666;
}

.perf-value {
    font-weight: 600;
    color: #333;
}

.distinct-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 15px;
}

.distinct-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.distinct-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.distinct-number {
    font-size: 2rem;
    font-weight: bold;
    color: #6366f1;
}

.distinct-year {
    background: #6366f1;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: bold;
}

.distinct-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.improve-badge {
    background: #10b981;
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
}

.freq-text {
    font-size: 0.85rem;
    color: #666;
}

.monthly-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
}

.month-breakdown-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.month-breakdown-card h4 {
    color: #6366f1;
    margin-bottom: 8px;
}

.month-draws {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 12px;
}

.month-hot-numbers {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
}

.hot-num-badge {
    background: #6366f1;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 0.9rem;
}

/* Heatmap and Trend Styles (NEW) */
.heatmaps-section,
.trends-section {
    margin-top: 40px;
    padding: 25px;
    background: #f9fafb;
    border-radius: 12px;
}

.heatmaps-section h3,
.trends-section h3 {
    color: #333;
    margin-bottom: 10px;
}

.heatmap-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.heatmap-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.heatmap-container h4 {
    color: #4f46e5;
    margin-bottom: 15px;
    text-align: center;
}

.heatmap-container canvas {
    min-height: 300px;
    max-height: 400px;
}

.trend-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.trend-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.trend-container.full-width {
    grid-column: 1 / -1;
}

.trend-container h4 {
    color: #10b981;
    margin-bottom: 15px;
    text-align: center;
}

.trend-container canvas {
    min-height: 250px;
}
</style>

{% endblock %}
